name: Update CRANDB

on:
  workflow_dispatch:
  schedule:
    - cron:  '45 * * * *'

jobs:
  gh-update:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/r-hub/cron/crandb:0.0.1
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        COUCHDB_PASSWORD: ${{ secrets.COUCHDB_PASSWORD }}
    steps:
      - name: Update
        run: |
          Rscript /root/update-crandb.R

  keep-alive:
    runs-on: ubuntu-latest
    needs: gh-update
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update activity timestamp
        run: |
          git checkout -B activity-log
          mkdir -p .github
          date > .github/last-run.txt
          git add .github/last-run.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update activity timestamp [skip ci]"
          git push origin activity-log --force
